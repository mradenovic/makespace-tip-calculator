<!-- Load the jQuery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js"
        integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="
        crossorigin="anonymous"></script>

<!-- Bootstrap Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

<!-- Custom client-side JavaScript code. -->
<script>
  // When the page loads.
  $(function() {
    setDefaultPeriod();
    $('#button-go').bind('click', loadTips);
  });
  
  /**
   * Set default period for tips view.
   */
  function setDefaultPeriod() {
    var start = new Date();
    start.setDate(0);
    start.setMonth(start.getMonth() - 1);
    var end = new Date();
    end.setDate(1);
    $('#date-start').val(start.toJSON().slice(0,10));
    $('#date-end').val(end.toJSON().slice(0,10));
  }
  
  /**
   * Load the tip list.
   */
  function loadTips() {
    timer = setInterval(getProgressData, 1000);
    $(".form-control").prop("disabled", true);
    $('#tip-table').empty();
    $('#tip-total').empty();
    $('#alerts').empty();
    $('#tips').hide();
    $('#progress-bar').show();
    var after = $('#date-start').val();
    var before = $('#date-end').val();
    google.script.run
        .withSuccessHandler(showTips)
        .withFailureHandler(showError)
        .getTips(after, before);
  }
  
  function getProgressData() {
    google.script.run
        .withSuccessHandler(updateProgress)
        .withFailureHandler(showError)
        .getProgressData();
  }
  
  function updateProgress(progressData) {
    $('#progress-info').text(progressData.progress + '%');
    $('#progress-info').css('width', progressData.progress + '%');
    $('#progress-info').prop('aria-valuenow', progressData.progress);
  }
  
  function resetProgress(progressData) {
    $('#progress-info').text('100%');
    $('#progress-bar').hide();
    $('#progress-info').text('0%');
    $('#progress-info').css('width', '2em');
    $('#progress-info').prop('aria-valuenow', 0);
  }
  
  /**
   * Show the returned tip list.
   * @param {Array.<Object>} tips The tip to show.
   */
  function showTips(tips) {
    clearInterval(timer);
    var list = $('#tip-table').empty();
    var yourShareTotal = 0;
    if (tips.length > 0) {
      tips.forEach(function(tip, index) {
        yourShareTotal += Number(tip.yourShare.replace(/[^0-9\.]+/g,""));
        var item = $('<tr>');

        if (tip.yourShare == '$0.00') {
          showAlert(tip);
          $(item).addClass('warning');
        }
        
        var total = $('<td class="text-right">')
            .text(tip.date);
        item.append(total);
        
        var customer = $('<td>')
            .text(tip.customer);
        item.append(customer);
        
        var total = $('<td class="text-right">')
            .text(tip.total);
        item.append(total);
        
        var yourShare = $('<td class="text-right">')
          .text(tip.yourShare);
        item.append(yourShare);
        
        list.append(item);
      });
      $('#tip-total').text('$' + yourShareTotal.toFixed(2));
    } else {
      $('#tip-total').text('$0.00');
    }
    resetProgress()
    $('#tips').show();
    $(".form-control").prop("disabled", false);
  }
  
  function showAlert(tip) {
    var alerts = $('#alerts');
    var alert = $('<div class="alert alert-warning alert-dismissible" role="alert">' +
                  '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                  'Warning: ' + 'Tip by customer ' + tip.customer + ' shows total ' + tip.total + ' and your share ' + tip.yourShare + '!' +
                  '</div>');
    alerts.append(alert);
  }
  
  /**
   * Logs an error message and shows an alert to the user.
   */
  function showError(error) {
    console.log(error);
    window.alert('An error has occurred, please try again.');
  }


</script>